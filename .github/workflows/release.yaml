name: Build Android Binaries

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-android:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: aarch64-linux-android,armv7-linux-androideabi,x86_64-linux-android,i686-linux-android
    
    - name: Setup Android NDK
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: r26c
        add-to-path: true
    
    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: ~/.cargo/registry
        key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Cache cargo index
      uses: actions/cache@v4
      with:
        path: ~/.cargo/git
        key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Cache cargo build
      uses: actions/cache@v4
      with:
        path: target
        key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Create cargo config
      run: |
        mkdir -p .cargo
        cat > .cargo/config.toml << EOF
        [target.aarch64-linux-android]
        linker = "$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android33-clang"
        ar = "$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar"
        
        [target.armv7-linux-androideabi]
        linker = "$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/armv7a-linux-androideabi33-clang"
        ar = "$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar"
        
        [target.x86_64-linux-android]
        linker = "$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/x86_64-linux-android33-clang"
        ar = "$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar"
        
        [target.i686-linux-android]
        linker = "$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/i686-linux-android33-clang"
        ar = "$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar"
        EOF
    
    - name: Build for ARM64 (aarch64)
      env:
        RUSTFLAGS: "-C target-feature=+crt-static -C link-arg=-static-libgcc"
      run: |
        cargo build --release --target aarch64-linux-android --bin slipstream-client
    
    - name: Build for ARM32 (armv7)
      env:
        RUSTFLAGS: "-C target-feature=+crt-static -C link-arg=-static-libgcc"
      run: |
        cargo build --release --target armv7-linux-androideabi --bin slipstream-client
    
    - name: Build for x86_64
      env:
        RUSTFLAGS: "-C target-feature=+crt-static -C link-arg=-static-libgcc"
      run: |
        cargo build --release --target x86_64-linux-android --bin slipstream-client
    
    - name: Build for x86 (i686)
      env:
        RUSTFLAGS: "-C target-feature=+crt-static -C link-arg=-static-libgcc"
      run: |
        cargo build --release --target i686-linux-android --bin slipstream-client
    
    - name: Organize binaries for Android Studio
      run: |
        mkdir -p android-libs/arm64-v8a
        mkdir -p android-libs/armeabi-v7a
        mkdir -p android-libs/x86_64
        mkdir -p android-libs/x86
        
        cp target/aarch64-linux-android/release/slipstream-client android-libs/arm64-v8a/libslipstream.so
        cp target/armv7-linux-androideabi/release/slipstream-client android-libs/armeabi-v7a/libslipstream.so
        cp target/x86_64-linux-android/release/slipstream-client android-libs/x86_64/libslipstream.so
        cp target/i686-linux-android/release/slipstream-client android-libs/x86/libslipstream.so
        
        # Verify files
        ls -lh android-libs/arm64-v8a/
        ls -lh android-libs/armeabi-v7a/
        ls -lh android-libs/x86_64/
        ls -lh android-libs/x86/
        
        # Check file types
        file android-libs/arm64-v8a/libslipstream.so
        file android-libs/armeabi-v7a/libslipstream.so
        file android-libs/x86_64/libslipstream.so
        file android-libs/x86/libslipstream.so
    
    - name: Upload Android libraries
      uses: actions/upload-artifact@v4
      with:
        name: android-slipstream-libs
        path: android-libs/
        retention-days: 90
    
    - name: Create Release (on tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          android-libs/arm64-v8a/libslipstream.so
          android-libs/armeabi-v7a/libslipstream.so
          android-libs/x86_64/libslipstream.so
          android-libs/x86/libslipstream.so
