name: Release slipstream

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:  # Allow manual trigger for testing

env:
  BUILD_TYPE: Release

jobs:
  build:
    name: Build (${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - arch: x86_64
            runner: ubuntu-latest
          - arch: arm64
            runner: ubuntu-24.04-arm

    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt install -y cmake git pkg-config libssl-dev ninja-build gcc g++ python3-pip
          pip3 install meson

      - name: Configure Meson
        run: |
          meson setup \
            -Db_lto=true \
            --buildtype=release \
            --warnlevel=0 \
            -Ddefault_library=static \
            meson-build-release

      - name: Build with Ninja
        run: |
          ninja -C meson-build-release

      - name: Rename Binaries
        run: |
          VERSION=${{ github.ref_name }}
          ARCH=${{ matrix.arch }}
          mkdir -p build
          mv ${{github.workspace}}/meson-build-release/slipstream-client ${{github.workspace}}/build/slipstream-client-${VERSION}-linux-${ARCH}
          mv ${{github.workspace}}/meson-build-release/slipstream-server ${{github.workspace}}/build/slipstream-server-${VERSION}-linux-${ARCH}

      - name: Upload Binaries
        uses: actions/upload-artifact@v4
        with:
          name: binaries-${{ matrix.arch }}
          path: |
            build/slipstream-client-${{ github.ref_name }}-linux-${{ matrix.arch }}
            build/slipstream-server-${{ github.ref_name }}-linux-${{ matrix.arch }}

  build-android:
    name: Build Android (${{ matrix.android_arch }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - android_arch: arm64-v8a
            target_triple: aarch64-linux-android
            api_level: 33
            openssl_target: android-arm64
          - android_arch: armeabi-v7a
            target_triple: armv7a-linux-androideabi
            api_level: 33
            openssl_target: android-arm
          - android_arch: x86_64
            target_triple: x86_64-linux-android
            api_level: 33
            openssl_target: android-x86_64
          - android_arch: x86
            target_triple: i686-linux-android
            api_level: 33
            openssl_target: android-x86

    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r26c
          add-to-path: true

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt install -y cmake git ninja-build python3-pip pkg-config perl
          pip3 install meson

      - name: Build OpenSSL for Android
        run: |
          # Clone OpenSSL
          git clone --depth 1 --branch openssl-3.0.15 https://github.com/openssl/openssl.git
          cd openssl
          
          # Set Android environment
          export ANDROID_NDK_ROOT=$ANDROID_NDK_HOME
          export PATH=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH
          
          # Configure and build OpenSSL
          ./Configure ${{ matrix.openssl_target }} \
            -D__ANDROID_API__=${{ matrix.api_level }} \
            --prefix=$HOME/openssl-${{ matrix.android_arch }} \
            no-shared \
            no-tests
          
          make -j$(nproc)
          make install_sw
          
          echo "✓ OpenSSL built successfully"
          ls -lh $HOME/openssl-${{ matrix.android_arch }}/lib/

      - name: Create Meson cross-file
        run: |
          OPENSSL_PREFIX="$HOME/openssl-${{ matrix.android_arch }}"
          
          cat > android-cross.ini << EOF
          [binaries]
          c = '$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/${{ matrix.target_triple }}${{ matrix.api_level }}-clang'
          cpp = '$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/${{ matrix.target_triple }}${{ matrix.api_level }}-clang++'
          ar = '$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar'
          strip = '$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip'
          pkg-config = '/usr/bin/pkg-config'
          cmake = '/usr/bin/cmake'

          [properties]
          sys_root = '$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/sysroot'

          [host_machine]
          system = 'android'
          cpu_family = '${{ matrix.android_arch == 'arm64-v8a' && 'aarch64' || matrix.android_arch == 'armeabi-v7a' && 'arm' || matrix.android_arch == 'x86_64' && 'x86_64' || 'x86' }}'
          cpu = '${{ matrix.android_arch == 'arm64-v8a' && 'aarch64' || matrix.android_arch == 'armeabi-v7a' && 'armv7a' || matrix.android_arch == 'x86_64' && 'x86_64' || 'i686' }}'
          endian = 'little'

          [cmake]
          OPENSSL_ROOT_DIR = '$OPENSSL_PREFIX'
          OPENSSL_INCLUDE_DIR = '$OPENSSL_PREFIX/include'
          OPENSSL_CRYPTO_LIBRARY = '$OPENSSL_PREFIX/lib/libcrypto.a'
          OPENSSL_SSL_LIBRARY = '$OPENSSL_PREFIX/lib/libssl.a'

          [built-in options]
          c_args = ['-I$OPENSSL_PREFIX/include']
          cpp_args = ['-I$OPENSSL_PREFIX/include', '-static-libstdc++']
          c_link_args = ['-static-libgcc', '$OPENSSL_PREFIX/lib/libssl.a', '$OPENSSL_PREFIX/lib/libcrypto.a']
          cpp_link_args = ['-static-libgcc', '-static-libstdc++', '$OPENSSL_PREFIX/lib/libssl.a', '$OPENSSL_PREFIX/lib/libcrypto.a']
          EOF
          
          echo "=== Meson cross-file ==="
          cat android-cross.ini

      - name: Configure Meson for Android
        env:
          PKG_CONFIG_PATH: ${{ env.HOME }}/openssl-${{ matrix.android_arch }}/lib/pkgconfig
        run: |
          meson setup \
            --cross-file android-cross.ini \
            -Db_lto=true \
            --buildtype=release \
            --warnlevel=0 \
            -Ddefault_library=static \
            build-android

      - name: Build with Ninja
        run: |
          ninja -C build-android -v

      - name: Prepare Android binary
        run: |
          mkdir -p android-libs/${{ matrix.android_arch }}
          
          # Copy the client binary
          cp build-android/slipstream-client android-libs/${{ matrix.android_arch }}/libslipstream.so
          
          # Strip debug symbols
          $ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip \
            android-libs/${{ matrix.android_arch }}/libslipstream.so
          
          echo "=== Binary Info ==="
          file android-libs/${{ matrix.android_arch }}/libslipstream.so
          ls -lh android-libs/${{ matrix.android_arch }}/libslipstream.so
          
          echo "=== Checking dependencies ==="
          $ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-readelf -d \
            android-libs/${{ matrix.android_arch }}/libslipstream.so | grep NEEDED || echo "✓ Statically linked"

      - name: Upload Android binary
        uses: actions/upload-artifact@v4
        with:
          name: android-${{ matrix.android_arch }}
          path: android-libs/${{ matrix.android_arch }}/libslipstream.so

  package-android:
    name: Package Android Libraries
    runs-on: ubuntu-latest
    needs: build-android
    permissions:
      contents: read

    steps:
      - name: Download all Android binaries
        uses: actions/download-artifact@v4
        with:
          pattern: android-*
          path: temp

      - name: Organize Android libraries
        run: |
          mkdir -p jniLibs/arm64-v8a
          mkdir -p jniLibs/armeabi-v7a
          mkdir -p jniLibs/x86_64
          mkdir -p jniLibs/x86
          
          cp temp/android-arm64-v8a/libslipstream.so jniLibs/arm64-v8a/
          cp temp/android-armeabi-v7a/libslipstream.so jniLibs/armeabi-v7a/
          cp temp/android-x86_64/libslipstream.so jniLibs/x86_64/
          cp temp/android-x86/libslipstream.so jniLibs/x86/
          
          # Create installation README
          cat > jniLibs/README.md << 'EOF'
          # Slipstream Android Native Libraries
          
          ## Installation
          
          Copy the entire `jniLibs` folder to your Android Studio project:
          
          ```
          YourApp/
          └── app/
              └── src/
                  └── main/
                      └── jniLibs/        <-- Copy this folder here
                          ├── arm64-v8a/
                          │   └── libslipstream.so
                          ├── armeabi-v7a/
                          │   └── libslipstream.so
                          ├── x86_64/
                          │   └── libslipstream.so
                          └── x86/
                              └── libslipstream.so
          ```
          
          ## Usage in Kotlin/Java
          
          ```kotlin
          val nativeLibDir = applicationInfo.nativeLibraryDir
          val binaryPath = File(nativeLibDir, "libslipstream.so").absolutePath
          
          // Execute the binary
          val process = ProcessBuilder(binaryPath, "domain.com", "1.1.1.1", "--socks-port", "1081")
              .redirectErrorStream(true)
              .start()
          ```
          
          ## Binary Information
          
          EOF
          
          echo "Built on: $(date)" >> jniLibs/README.md
          echo "Commit: ${{ github.sha }}" >> jniLibs/README.md
          echo "" >> jniLibs/README.md
          echo "### File Sizes" >> jniLibs/README.md
          echo '```' >> jniLibs/README.md
          ls -lh jniLibs/*/*.so >> jniLibs/README.md
          echo '```' >> jniLibs/README.md
          
          cat jniLibs/README.md

      - name: Create archive
        run: |
          zip -r slipstream-android-jniLibs.zip jniLibs/
          sha256sum slipstream-android-jniLibs.zip > slipstream-android-jniLibs.zip.sha256
          
          echo "=== Archive created ==="
          ls -lh slipstream-android-jniLibs.zip
          cat slipstream-android-jniLibs.zip.sha256

      - name: Upload packaged libraries
        uses: actions/upload-artifact@v4
        with:
          name: android-jniLibs-package
          path: |
            slipstream-android-jniLibs.zip
            slipstream-android-jniLibs.zip.sha256

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build, package-android]
    if: github.ref_type == 'tag'
    permissions:
      contents: write

    steps:
      - name: Download all binaries
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          generate_release_notes: true
          files: |
            artifacts/slipstream-*
            artifacts/*.zip
            artifacts/*.sha256

  docker-build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      attestations: write
      id-token: write

    env:
      REGISTRY: ghcr.io
      IMAGE_NAME: ${{ github.repository }}

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Extract metadata (tags, labels) for Docker (server)
        id: meta-server
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-server

      - name: Extract metadata (tags, labels) for Docker (client)
        id: meta-client
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-client

      - name: Build and push Docker image (server)
        id: push-server
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          platforms: linux/amd64,linux/arm64
          tags: ${{ steps.meta-server.outputs.tags }}
          labels: ${{ steps.meta-server.outputs.labels }}
          target: server

      - name: Build and push Docker image (client)
        id: push-client
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          platforms: linux/amd64,linux/arm64
          tags: ${{ steps.meta-client.outputs.tags }}
          labels: ${{ steps.meta-client.outputs.labels }}
          target: client

      - name: Generate artifact attestation (server)
        uses: actions/attest-build-provenance@v2
        with:
          subject-name: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-server
          subject-digest: ${{ steps.push-server.outputs.digest }}
          push-to-registry: true

      - name: Generate artifact attestation (client)
        uses: actions/attest-build-provenance@v2
        with:
          subject-name: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-client
          subject-digest: ${{ steps.push-client.outputs.digest }}
          push-to-registry: true
