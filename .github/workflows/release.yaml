name: Release slipstream

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:  # Allow manual trigger

env:
  BUILD_TYPE: Release

jobs:
  build:
    name: Build (${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - arch: x86_64
            runner: ubuntu-latest
          - arch: arm64
            runner: ubuntu-24.04-arm

    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt install -y cmake git pkg-config libssl-dev ninja-build gcc g++ python3-pip
          pip3 install meson

      - name: Configure Meson
        run: |
          meson setup \
            -Db_lto=true \
            --buildtype=release \
            --warnlevel=0 \
            -Ddefault_library=static \
            meson-build-release

      - name: Build with Ninja
        run: |
          ninja -C meson-build-release

      - name: Rename Binaries
        run: |
          VERSION=${{ github.ref_name }}
          ARCH=${{ matrix.arch }}
          mkdir -p build
          mv ${{github.workspace}}/meson-build-release/slipstream-client ${{github.workspace}}/build/slipstream-client-${VERSION}-linux-${ARCH}
          mv ${{github.workspace}}/meson-build-release/slipstream-server ${{github.workspace}}/build/slipstream-server-${VERSION}-linux-${ARCH}

      - name: Upload Binaries
        uses: actions/upload-artifact@v4
        with:
          name: binaries-${{ matrix.arch }}
          path: |
            build/slipstream-client-${{ github.ref_name }}-linux-${{ matrix.arch }}
            build/slipstream-server-${{ github.ref_name }}-linux-${{ matrix.arch }}

  build-android:
    name: Build Android (${{ matrix.arch }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - arch: arm64-v8a
            target: aarch64-linux-android
            api: 33
          - arch: armeabi-v7a
            target: armv7a-linux-androideabi
            api: 33
          - arch: x86_64
            target: x86_64-linux-android
            api: 33
          - arch: x86
            target: i686-linux-android
            api: 33

    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r26c
          add-to-path: true

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt install -y cmake git pkg-config ninja-build python3-pip
          pip3 install meson

      - name: Setup Android cross-compilation environment
        run: |
          echo "NDK_ROOT=$ANDROID_NDK_HOME" >> $GITHUB_ENV
          echo "TOOLCHAIN=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64" >> $GITHUB_ENV

      - name: Create Meson cross-file
        run: |
          cat > android-${{ matrix.arch }}.txt << EOF
          [binaries]
          c = '${{ env.TOOLCHAIN }}/bin/${{ matrix.target }}${{ matrix.api }}-clang'
          cpp = '${{ env.TOOLCHAIN }}/bin/${{ matrix.target }}${{ matrix.api }}-clang++'
          ar = '${{ env.TOOLCHAIN }}/bin/llvm-ar'
          strip = '${{ env.TOOLCHAIN }}/bin/llvm-strip'
          pkgconfig = '/usr/bin/pkg-config'

          [host_machine]
          system = 'android'
          cpu_family = '${{ matrix.arch == 'arm64-v8a' && 'aarch64' || matrix.arch == 'armeabi-v7a' && 'arm' || matrix.arch == 'x86_64' && 'x86_64' || 'x86' }}'
          cpu = '${{ matrix.arch == 'arm64-v8a' && 'aarch64' || matrix.arch == 'armeabi-v7a' && 'armv7a' || matrix.arch == 'x86_64' && 'x86_64' || 'i686' }}'
          endian = 'little'

          [properties]
          needs_exe_wrapper = true
          c_args = ['-static-libgcc', '-fPIC']
          cpp_args = ['-static-libgcc', '-fPIC', '-static-libstdc++']
          c_link_args = ['-static-libgcc']
          cpp_link_args = ['-static-libgcc', '-static-libstdc++']
          EOF

      - name: Configure Meson for Android
        run: |
          meson setup \
            --cross-file android-${{ matrix.arch }}.txt \
            -Db_lto=true \
            --buildtype=release \
            --warnlevel=0 \
            -Ddefault_library=static \
            meson-build-android-${{ matrix.arch }}

      - name: Build with Ninja
        run: |
          ninja -C meson-build-android-${{ matrix.arch }}

      - name: Organize Android binaries
        run: |
          mkdir -p android-libs/${{ matrix.arch }}
          cp meson-build-android-${{ matrix.arch }}/slipstream-client android-libs/${{ matrix.arch }}/libslipstream.so
          
          echo "=== Binary Info for ${{ matrix.arch }} ==="
          ls -lh android-libs/${{ matrix.arch }}/libslipstream.so
          file android-libs/${{ matrix.arch }}/libslipstream.so
          
          # Check dependencies
          echo "=== Checking dynamic dependencies ==="
          $ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-readelf -d android-libs/${{ matrix.arch }}/libslipstream.so | grep NEEDED || echo "No dynamic dependencies (statically linked)"

      - name: Upload Android library
        uses: actions/upload-artifact@v4
        with:
          name: android-${{ matrix.arch }}
          path: android-libs/${{ matrix.arch }}/libslipstream.so
          retention-days: 90

  package-android:
    name: Package Android Libraries
    runs-on: ubuntu-latest
    needs: build-android
    permissions:
      contents: read

    steps:
      - name: Download all Android binaries
        uses: actions/download-artifact@v4
        with:
          pattern: android-*
          path: android-libs-temp

      - name: Organize for Android Studio
        run: |
          mkdir -p android-libs/arm64-v8a
          mkdir -p android-libs/armeabi-v7a
          mkdir -p android-libs/x86_64
          mkdir -p android-libs/x86
          
          cp android-libs-temp/android-arm64-v8a/libslipstream.so android-libs/arm64-v8a/
          cp android-libs-temp/android-armeabi-v7a/libslipstream.so android-libs/armeabi-v7a/
          cp android-libs-temp/android-x86_64/libslipstream.so android-libs/x86_64/
          cp android-libs-temp/android-x86/libslipstream.so android-libs/x86/
          
          # Create README
          cat > android-libs/README.md << EOF
          # Slipstream Android Libraries
          
          Copy these folders to your Android Studio project:
          \`\`\`
          app/src/main/jniLibs/
          ├── arm64-v8a/
          │   └── libslipstream.so
          ├── armeabi-v7a/
          │   └── libslipstream.so
          ├── x86_64/
          │   └── libslipstream.so
          └── x86/
              └── libslipstream.so
          \`\`\`
          
          Built on: $(date)
          Commit: ${{ github.sha }}
          EOF
          
          tree android-libs || ls -laR android-libs

      - name: Create Android libs archive
        run: |
          cd android-libs
          zip -r ../slipstream-android-libs.zip .
          cd ..
          sha256sum slipstream-android-libs.zip > slipstream-android-libs.zip.sha256

      - name: Upload packaged Android libraries
        uses: actions/upload-artifact@v4
        with:
          name: android-libs-packaged
          path: |
            slipstream-android-libs.zip
            slipstream-android-libs.zip.sha256

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build, build-android, package-android]
    if: github.ref_type == 'tag'
    permissions:
      contents: write

    steps:
      - name: Download all binaries
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: List all artifacts
        run: |
          echo "=== All artifacts ==="
          ls -laR artifacts/

      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          generate_release_notes: true
          files: |
            artifacts/slipstream-*
            artifacts/*.zip
            artifacts/*.sha256

  docker-build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      attestations: write
      id-token: write

    env:
      REGISTRY: ghcr.io
      IMAGE_NAME: ${{ github.repository }}

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Extract metadata (tags, labels) for Docker (server)
        id: meta-server
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-server

      - name: Extract metadata (tags, labels) for Docker (client)
        id: meta-client
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-client

      - name: Build and push Docker image (server)
        id: push-server
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          platforms: linux/amd64,linux/arm64
          tags: ${{ steps.meta-server.outputs.tags }}
          labels: ${{ steps.meta-server.outputs.labels }}
          target: server

      - name: Build and push Docker image (client)
        id: push-client
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          platforms: linux/amd64,linux/arm64
          tags: ${{ steps.meta-client.outputs.tags }}
          labels: ${{ steps.meta-client.outputs.labels }}
          target: client

      - name: Generate artifact attestation (server)
        uses: actions/attest-build-provenance@v2
        with:
          subject-name: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-server
          subject-digest: ${{ steps.push-server.outputs.digest }}
          push-to-registry: true

      - name: Generate artifact attestation (client)
        uses: actions/attest-build-provenance@v2
        with:
          subject-name: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-client
          subject-digest: ${{ steps.push-client.outputs.digest }}
          push-to-registry: true
